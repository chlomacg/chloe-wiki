<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
	<link href="site.css" rel="stylesheet" type="text/css" media="all">
</head>

<body>
<script src="./assets/brevislib.js"></script>
<script type="text/javascript" language="javascript" src="./playground.js"></script>
<div class="flex-container" id="main">
	<nav>
	<b>
		<a style="text-decoration: none;" href="./index.html">Introduction</a>
		<br>
		<a style="text-decoration: none;" href="./playground.html">Playground</a>
		<br>
		<a style="text-decoration: none;" href="./tutorial.html">Tutorial</a>
		<br>
		<a style="text-decoration: none;" href="./spec.html">Spec</a>
		<br>
		<a style="text-decoration: none;" href="./about.html">About</a>
	</b>
	</nav>
	<article>
		<h1 class="title">
			Brevis: Playground
		</h1>
		<p>
			This is a (Work-In-Progress) place to write and run small Brevis programs! When you click the "Run!" button, the code you write will be lexed, parsed, transformed into A-Normal-Form (ANF), and be compiled to 3 target languages &mdash; C (C89), JavaScript (ES6), and Python (3.8+), all by the Brevis compiler embedded in this website. The generated JavaScript code will then be run by your browser (if possible), and the output will be shown in the "Output" tab. Some features notably lacking in this site are good errors (the ones generated by the embedded compiler are nonsensical stack traces), displayed errors at all, and any indication of error during compilation at all (if the button quickly un-depresses and the Output tab stays as "Loading", the compiler probably errored. Sorry). As for the Brevis code generator itself, the C output fails to properly compile closures, but pretends that it knows how. This will be fixed soon.
		</p>
		<h3>
			Code
		</h3>
		<p>
			The code here by default generates an ascii rendition of the mandelbrot set, on a canvas X "pixels" wide. If you want a more accurate rendering, change the value draw_mandelbrot is called with to a higher one, and zoom out your page! (pro tip for writing code here: <kbd>Shift</kbd> + <kbd>Tab</kbd> enters a literal tab into the code!)
		</p>



    	<button type="button" onclick="set_source(mandelbrot)">Mandelbrot</button>
    	<button type="button" onclick="set_source(fizzbuzz)">FizzBuzz</button>
    	<button type="button" onclick="set_source(factors)">Factors</button>
	<br>


    	<textarea id="brevis_source" spellcheck="false" rows="20"></textarea>
		<br>
    	<button type="button" onclick="compile('brevis_source')">Run!</button>
    	<div class="tab-bar" id="output_tabs" style="display:none">
      	  <button class="tablink" onclick="openOutput('stdout')">Output</button>
      	  <button class="tablink" onclick="openOutput('c')">C</button>
        	<button class="tablink" onclick="openOutput('js')">Javascript</button>
        	<button class="tablink" onclick="openOutput('py')">Python</button>
		</div>
    	<div id="output" style="display:none">
        	<pre id="stdout" class="out"><code></code></pre>
        	<pre id="py" class="out" style="display:none"><code></code></pre>
        	<pre id="c" class="out" style="display:none"><code></code></pre>
        	<pre id="js" class="out" style="display:none"><code></code></pre>
    	</div>
	</article>
	

	<script>
	mandelbrot = `let Bailout = 16.0;
let Maxiter = 1000;

let for_range = fn(low, high, f) {
	if low <= high {
		f(low);
		for_range(low + 1.0, high, f);
	}
};

let mandelbrot = fn(x, y) {
	let cr = y - 0.5;
	let ci = x;

	let aux = fn(i, zr, zi) {
		i = i + 1;
		let tmp = zr * zi;
		let zr2 = zr * zr;
		let zi2 = zi * zi;
		zr = zr2 - zi2 + cr;
		zi = tmp + tmp + ci;

		if zi2 + zr2 > Bailout {
			i
		} else if i > Maxiter {
			0
		} else {
			aux(i, zr, zi)
		}
	};

	aux(0, 0.0, 0.0)
};

let draw_mandelbrot = fn(size) {
	for_range(-size, size,
		fn(y) {
			for_range(-size, size,
				fn(x) {
					let i = mandelbrot(x/(size + 1.0), y/(size + 1.0));
					if i == 0 {
						print("*");
					} else {
						print(" ");
					}
				}
			);
			print("\\n");
		}
	)
};

draw_mandelbrot(40.0);`;
	fizzbuzz = `let fizzbuzz = fn(from, to) {
	let aux = fn(n, accumulator) {
		if (n % 3) == 0 {
			accumulator = accumulator ~ "Fizz";
		};
		if (n % 5) == 0 {
			accumulator = accumulator ~ "Buzz";
		};
		if (n % 3) != 0 and (n % 5) != 0 {
			accumulator = accumulator ~ itoa(n);
		};
		accumulator = accumulator ~ "\\n";

		if n == to {
			accumulator
		} else {
			n =
				if n < to {
					n + 1
				} else {
					n - 1
				};
			aux(n, accumulator)
		}
	};

	aux(from, "")
};

print(fizzbuzz(1, 100));`;

	factors = `let for_range = fn(low, high, f) {
	if low <= high {
		f(low);
		for_range(low + 1, high, f);
	}
};

let print_factors = fn(n) {
	let factors_str = fn(sub_n, factor) {
		if (sub_n % factor) == 0 {
			itoa(factor)
		} else {
			""
		}
	};

	for_range(0, n,
		fn(sub_n) {
			let factors = factors_str(n, sub_n);
			factors = factors ~
					if sub_n != n and factors != "" { ", " } else "";
			print(factors);
		}
	);
};

print_factors(5120);`;
	

	function set_source(src) {
		document.getElementById("brevis_source").innerHTML = src;
	}

	set_source(mandelbrot);
	</script>
</div>
</body>
</html>
